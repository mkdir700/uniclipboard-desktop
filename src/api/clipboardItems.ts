import { invoke } from '@tauri-apps/api/core'

// Backend projection type
interface ClipboardEntryProjection {
  id: string
  preview: string // Preview content (may be truncated)
  has_detail: boolean // Whether full detail is available
  size_bytes: number
  captured_at: number
  content_type: string
  is_encrypted: boolean
  is_favorited: boolean
  updated_at: number
  active_time: number
}

// Detail response type (for fetching full content)
export interface ClipboardEntryDetail {
  id: string
  content: string // Full content
  content_type: string
  size_bytes: number
  is_favorited: boolean
  updated_at: number
  active_time: number
}

/**
 * 排序选项枚举
 */
export enum OrderBy {
  CreatedAtAsc = 'created_at_asc',
  CreatedAtDesc = 'created_at_desc',
  UpdatedAtAsc = 'updated_at_asc',
  UpdatedAtDesc = 'updated_at_desc',
  ContentTypeAsc = 'content_type_asc',
  ContentTypeDesc = 'content_type_desc',
  IsFavoritedAsc = 'is_favorited_asc',
  IsFavoritedDesc = 'is_favorited_desc',
  ActiveTimeAsc = 'active_time_asc',
  ActiveTimeDesc = 'active_time_desc',
}

/**
 * 过滤选项枚举
 */
export enum Filter {
  All = 'all',
  Favorited = 'favorited',
  Text = 'text',
  Image = 'image',
  Link = 'link',
  Code = 'code',
  File = 'file',
}

export interface ClipboardTextItem {
  display_text: string // Changed: now always shows preview
  has_detail: boolean // NEW: replaced is_truncated, indicates if full content is available
  size: number
}

export interface ClipboardImageItem {
  thumbnail: string
  size: number
  width: number
  height: number
}

export interface ClipboardFileItem {
  file_names: string[]
  file_sizes: number[]
}

export interface ClipboardLinkItem {
  url: string
}

export interface ClipboardCodeItem {
  code: string
}

export interface ClipboardItem {
  text: ClipboardTextItem
  image: ClipboardImageItem
  file: ClipboardFileItem
  link: ClipboardLinkItem
  code: ClipboardCodeItem
  unknown: null
}

export interface ClipboardItemResponse {
  id: string
  is_downloaded: boolean
  is_favorited: boolean
  created_at: number
  updated_at: number
  active_time: number
  item: ClipboardItem
}

export interface ClipboardStats {
  total_items: number
  total_size: number
}

/**
 * 获取剪贴板统计信息
 * @returns Promise，返回剪贴板统计信息
 */
export async function getClipboardStats(): Promise<ClipboardStats> {
  try {
    return await invoke('get_clipboard_stats')
  } catch (error) {
    console.error('获取剪贴板统计信息失败:', error)
    throw error
  }
}

/**
 * 获取剪贴板历史记录
 * @param orderBy 排序方式（暂未实现）
 * @param limit 限制返回的条目数
 * @param offset 偏移量，用于分页（暂未实现）
 * @param filter 过滤选项（暂未实现）
 * @returns Promise，返回剪贴板条目数组
 */
export async function getClipboardItems(
  _orderBy?: OrderBy,
  limit?: number,
  offset?: number,
  _filter?: Filter
): Promise<ClipboardItemResponse[]> {
  try {
    // Note: orderBy and filter are not yet implemented in the backend command
    // Map Filter enum to backend format if needed (for future use)
    // const mappedFilter = filter === Filter.All ? undefined : filter

    // Use new command name: get_clipboard_entries
    const entries = await invoke<ClipboardEntryProjection[]>('get_clipboard_entries', {
      limit: limit ?? 50,
      offset: offset ?? 0,
    })

    // Transform backend projection to frontend response format
    // TODO: Currently treating all entries as text. Implement proper content type detection
    // when backend provides accurate content_type values
    return entries.map(entry => ({
      id: entry.id,
      is_downloaded: true, // Default to true for local entries
      is_favorited: entry.is_favorited,
      created_at: entry.captured_at,
      updated_at: entry.updated_at,
      active_time: entry.active_time,
      item: {
        text: {
          display_text: entry.preview, // Use preview directly from backend
          has_detail: entry.has_detail, // Use has_detail from backend (indicates expandability)
          size: entry.size_bytes,
        },
        image: null as unknown as ClipboardImageItem,
        file: null as unknown as ClipboardFileItem,
        link: null as unknown as ClipboardLinkItem,
        code: null as unknown as ClipboardCodeItem,
        unknown: null,
      },
    }))
  } catch (error) {
    console.error('获取剪贴板历史记录失败:', error)
    throw error
  }
}

/**
 * 获取单个剪贴板条目
 * @param id 剪贴板条目ID
 * @param fullContent 是否获取完整内容，不进行截断
 * @returns Promise，返回剪贴板条目，若不存在则返回null
 */
export async function getClipboardItem(
  id: string,
  fullContent: boolean = false
): Promise<ClipboardItemResponse | null> {
  try {
    return await invoke('get_clipboard_item', { id, fullContent })
  } catch (error) {
    console.error('获取剪贴板条目失败:', error)
    throw error
  }
}

/**
 * Get clipboard entry detail (full content)
 * 获取剪切板条目详情（完整内容）
 * @param id Entry ID
 * @returns Promise with full entry detail
 */
export async function getClipboardEntryDetail(id: string): Promise<ClipboardEntryDetail> {
  try {
    return await invoke('get_clipboard_entry_detail', { entryId: id })
  } catch (error) {
    console.error('Failed to get clipboard entry detail:', error)
    throw error
  }
}

/**
 * 删除剪贴板条目
 * @param id 剪贴板条目ID
 * @returns Promise，成功返回true
 */
export async function deleteClipboardItem(id: string): Promise<boolean> {
  try {
    return await invoke('delete_clipboard_entry', { entryId: id })
  } catch (error) {
    console.error('删除剪贴板条目失败:', error)
    throw error
  }
}

/**
 * 清空所有剪贴板历史记录
 * @returns Promise，成功返回删除的条目数
 */
export async function clearClipboardItems(): Promise<number> {
  try {
    return await invoke('clear_clipboard_items')
  } catch (error) {
    console.error('清空剪贴板历史记录失败:', error)
    throw error
  }
}

/**
 * 同步剪贴板内容
 * @returns Promise，成功返回true
 */
export async function syncClipboardItems(): Promise<boolean> {
  try {
    return await invoke('sync_clipboard_items')
  } catch (error) {
    console.error('同步剪贴板内容失败:', error)
    throw error
  }
}

/**
 * 复制剪贴板内容
 * @param id 剪贴板条目ID
 * @returns Promise，成功返回true
 */
export async function copyClipboardItem(id: string): Promise<boolean> {
  try {
    return await invoke('copy_clipboard_item', { id })
  } catch (error) {
    console.error('复制剪贴板记录失败:', error)
    throw error
  }
}

/**
 * 根据内容类型获取符合前端显示的类型
 * @param contentType 内容类型字符串
 * @returns 适合UI显示的类型
 */
export function getDisplayType(
  item: ClipboardItem
): 'text' | 'image' | 'link' | 'code' | 'file' | 'unknown' {
  if (item.text) {
    return 'text'
  } else if (item.image) {
    return 'image'
  } else if (item.file) {
    return 'file'
  } else if (item.link) {
    return 'link'
  } else if (item.code) {
    return 'code'
  } else {
    return 'unknown'
  }
}

/**
 * 判断是否为图片类型
 * @param contentType 内容类型
 * @returns 是否为图片
 */
export function isImageType(contentType: string): boolean {
  return contentType === 'image' || contentType.startsWith('image/')
}

/**
 * 判断是否为文本类型
 * @param contentType 内容类型
 * @returns 是否为文本
 */
export function isTextType(contentType: string): boolean {
  return contentType === 'text' || contentType.startsWith('text/')
}

/**
 * 收藏剪贴板条目
 * @param id 剪贴板条目ID
 * @returns Promise，成功返回true
 */
export async function favoriteClipboardItem(id: string): Promise<boolean> {
  try {
    return await invoke('toggle_favorite_clipboard_item', { id, isFavorited: true })
  } catch (error) {
    console.error('收藏剪贴板条目失败:', error)
    throw error
  }
}

/**
 * 取消收藏剪贴板条目
 * @param id 剪贴板条目ID
 * @returns Promise，成功返回true
 */
export async function unfavoriteClipboardItem(id: string): Promise<boolean> {
  try {
    return await invoke('toggle_favorite_clipboard_item', { id, isFavorited: false })
  } catch (error) {
    console.error('取消收藏剪贴板条目失败:', error)
    throw error
  }
}
